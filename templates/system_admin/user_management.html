{% extends 'base/base.html' %}

{% block title %}User Management - System Admin{% endblock %}

{% block user_name %}{{ user.first_name }} {{ user.last_name }}{% endblock %}

{% block sidebar %}
<a class="nav-link" href="{% url 'system_admin:dashboard' %}">
    <i class="bi bi-speedometer2 me-2"></i>Dashboard
</a>
<a class="nav-link active" href="{% url 'system_admin:user_management' %}">
    <i class="bi bi-people me-2"></i>User Management
</a>
<a class="nav-link" href="{% url 'system_admin:system_config' %}">
    <i class="bi bi-gear me-2"></i>System Config
</a>
<a class="nav-link" href="{% url 'system_admin:analytics' %}">
    <i class="bi bi-graph-up me-2"></i>Reports & Analytics
</a>
<a class="nav-link" href="{% url 'system_admin:audit_logs' %}">
    <i class="bi bi-file-text me-2"></i>Audit Logs
</a>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'system_admin:dashboard' %}">System Admin</a></li>
<li class="breadcrumb-item active">User Management</li>
{% endblock %}

{% block page_title %}User Management{% endblock %}

{% block page_actions %}
<button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createUserModal">
    <i class="bi bi-person-plus me-2"></i>Create User
</button>
<button class="btn btn-outline-primary me-2" onclick="exportUsers()">
    <i class="bi bi-download me-2"></i>Export
</button>
<button class="btn btn-outline-secondary" onclick="refreshUserList()">
    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
</button>
{% endblock %}

{% block content %}
<!-- User Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0" id="totalUsersCount">{{ total_users }}</h4>
                        <p class="card-text">Total Users</p>
                    </div>
                    <i class="bi bi-people fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0" id="employeesCount">{{ employees_count }}</h4>
                        <p class="card-text">Employees</p>
                    </div>
                    <i class="bi bi-person fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0" id="adminsCount">{{ canteen_admins_count }}</h4>
                        <p class="card-text">Canteen Admins</p>
                    </div>
                    <i class="bi bi-shop fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0" id="activeUsersCount">{{ active_users_count }}</h4>
                        <p class="card-text">Active Today</p>
                    </div>
                    <i class="bi bi-activity fs-1 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Management Interface -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>All Users
                </h5>
            </div>
            <div class="col-md-6">
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" 
                               class="form-control" 
                               id="searchUsers" 
                               placeholder="Search users...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterByRole">
                            <option value="">All Roles</option>
                            <option value="employee">Employees</option>
                            <option value="canteen_admin">Canteen Admins</option>
                            <option value="system_admin">System Admins</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterByStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Users Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead class="table-light">
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}" class="user-row">
                        <td>
                            <input type="checkbox" class="form-check-input user-checkbox" value="{{ user.id }}">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    <i class="bi bi-person-circle text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ user.first_name }} {{ user.last_name }}</h6>
                                    <small class="text-muted">@{{ user.username }}</small>
                                    {% if user.email %}
                                        <br><small class="text-muted">{{ user.email }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-{{ user.role_color }} fs-6">
                                {{ user.get_role_display }}
                            </span>
                        </td>
                        <td>{{ user.department|default:"Not assigned" }}</td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.last_login %}
                                <span class="text-muted">{{ user.last_login|timesince }} ago</span>
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-muted">{{ user.date_joined|date:"M d, Y" }}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" 
                                        onclick="viewUser({{ user.id }})" 
                                        title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" 
                                        onclick="editUser({{ user.id }})" 
                                        title="Edit User">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-info" 
                                        onclick="resetPassword({{ user.id }})" 
                                        title="Reset Password">
                                    <i class="bi bi-key"></i>
                                </button>
                                {% if user.role != 'system_admin' %}
                                <button class="btn btn-outline-danger" 
                                        onclick="toggleUserStatus({{ user.id }}, {{ user.is_active|yesno:'false,true' }})" 
                                        title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %} User">
                                    <i class="bi bi-{% if user.is_active %}x-circle{% else %}check-circle{% endif %}"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="bi bi-people fs-1"></i>
                            <p class="mt-2">No users found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Showing {{ users|length }} of {{ total_users }} users
            </div>
            <nav aria-label="Users pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item">
                        <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Create New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createUserForm" method="post" action="{% url 'system_admin:create_user' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">First Name *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="first_name" 
                                   name="first_name" 
                                   placeholder="Enter first name"
                                   required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Last Name *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="last_name" 
                                   name="last_name" 
                                   placeholder="Enter last name"
                                   required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="username" 
                                   name="username" 
                                   placeholder="Enter username"
                                   pattern="[a-zA-Z0-9._-]+"
                                   title="Only letters, numbers, dots, underscores, and hyphens allowed"
                                   required>
                            <div class="invalid-feedback"></div>
                            <div class="valid-feedback">
                                <i class="bi bi-check-circle me-1"></i>Username is available!
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employee_id" class="form-label">Employee ID</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="employee_id" 
                                   name="employee_id" 
                                   placeholder="Enter employee ID">
                            <div class="form-text">Optional - for employees only</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" 
                                   class="form-control" 
                                   id="email" 
                                   name="email" 
                                   placeholder="Enter email address">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" name="department">
                                <option value="">Select Department</option>
                                <option value="IT">Information Technology</option>
                                <option value="HR">Human Resources</option>
                                <option value="Finance">Finance</option>
                                <option value="Operations">Operations</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Sales">Sales</option>
                                <option value="Management">Management</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="role" class="form-label">User Role *</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check role-card">
                                    <input class="form-check-input" 
                                           type="radio" 
                                           name="role" 
                                           id="role_employee" 
                                           value="employee" 
                                           checked>
                                    <label class="form-check-label w-100" for="role_employee">
                                        <div class="text-center p-3 border rounded">
                                            <i class="bi bi-person fs-2 text-primary d-block mb-2"></i>
                                            <strong>Employee</strong>
                                            <p class="small text-muted mb-0">Place orders, view menu, track orders</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check role-card">
                                    <input class="form-check-input" 
                                           type="radio" 
                                           name="role" 
                                           id="role_canteen_admin" 
                                           value="canteen_admin">
                                    <label class="form-check-label w-100" for="role_canteen_admin">
                                        <div class="text-center p-3 border rounded">
                                            <i class="bi bi-shop fs-2 text-success d-block mb-2"></i>
                                            <strong>Canteen Admin</strong>
                                            <p class="small text-muted mb-0">Manage menu, process orders, notifications</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check role-card">
                                    <input class="form-check-input" 
                                           type="radio" 
                                           name="role" 
                                           id="role_system_admin" 
                                           value="system_admin">
                                    <label class="form-check-label w-100" for="role_system_admin">
                                        <div class="text-center p-3 border rounded">
                                            <i class="bi bi-gear fs-2 text-warning d-block mb-2"></i>
                                            <strong>System Admin</strong>
                                            <p class="small text-muted mb-0">Full system access and user management</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password *</label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control" 
                                       id="password" 
                                       name="password" 
                                       placeholder="Enter password"
                                       minlength="8"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePasswordVisibility('password')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" 
                                        type="button" 
                                        onclick="generatePassword()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="password-strength mt-2" id="passwordStrength">
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar" id="strengthBar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="strengthText">Password strength will appear here</small>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="confirm_password" class="form-label">Confirm Password *</label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control" 
                                       id="confirm_password" 
                                       name="confirm_password" 
                                       placeholder="Confirm password"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePasswordVisibility('confirm_password')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback"></div>
                            <div class="valid-feedback">
                                <i class="bi bi-check-circle me-1"></i>Passwords match!
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="send_credentials" 
                                   name="send_credentials" 
                                   checked>
                            <label class="form-check-label" for="send_credentials">
                                Send login credentials to user's email
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Users can only modify their username and password. All other details must be updated by System Admin.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="createUserBtn">
                        <i class="bi bi-person-plus me-2"></i>Create User
                        <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>Edit User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editUserContent">
                <!-- Content loaded via AJAX -->
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person me-2"></i>User Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Content loaded via AJAX -->
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key me-2"></i>Reset Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="resetPasswordForm">
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Are you sure you want to reset this user's password? This action cannot be undone.
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password_reset" class="form-label">New Password *</label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="new_password_reset" 
                                   placeholder="Enter new password"
                                   minlength="8"
                                   required>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    onclick="togglePasswordVisibility('new_password_reset')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" 
                                    type="button" 
                                    onclick="generatePasswordReset()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="force_password_change" 
                               checked>
                        <label class="form-check-label" for="force_password_change">
                            Force user to change password on next login
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" id="resetPasswordBtn">
                        <i class="bi bi-key me-2"></i>Reset Password
                        <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// System Admin User Management JavaScript
class UserManager {
    constructor() {
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupFormValidation();
        this.setupFilters();
    }

    setupEventListeners() {
        // Search functionality
        document.getElementById('searchUsers')?.addEventListener('input', (e) => {
            this.filterUsers();
        });

        // Role and status filters
        document.getElementById('filterByRole')?.addEventListener('change', () => {
            this.filterUsers();
        });

        document.getElementById('filterByStatus')?.addEventListener('change', () => {
            this.filterUsers();
        });

        // Select all checkbox
        document.getElementById('selectAll')?.addEventListener('change', (e) => {
            this.toggleSelectAll(e.target.checked);
        });

        // Individual checkboxes
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                this.updateSelectAllState();
            });
        });

        // Username availability check
        const usernameInput = document.getElementById('username');
        if (usernameInput) {
            let debounceTimer;
            usernameInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    this.checkUsernameAvailability(e.target.value);
                }, 500);
            });
        }

        // Password strength checker
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
            passwordInput.addEventListener('input', (e) => {
                this.checkPasswordStrength(e.target.value);
            });
        }

        // Password confirmation
        document.getElementById('confirm_password')?.addEventListener('input', () => {
            this.validatePasswordConfirmation();
        });

        // Form submissions
        document.getElementById('createUserForm')?.addEventListener('submit', (e) => {
            this.handleCreateUserSubmit(e);
        });

        document.getElementById('resetPasswordForm')?.addEventListener('submit', (e) => {
            this.handleResetPasswordSubmit(e);
        });

        // Role card selection styling
        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.updateRoleCardSelection(e.target.value);
            });
        });
    }

    setupFormValidation() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            const inputs = form.querySelectorAll('input[required]');
            inputs.forEach(input => {
                input.addEventListener('blur', () => {
                    this.validateInput(input);
                });
                
                input.addEventListener('input', () => {
                    this.clearValidation(input);
                });
            });
        });
    }

    setupFilters() {
        // Initialize filter state
        this.originalRows = Array.from(document.querySelectorAll('#usersTableBody tr'));
    }

    filterUsers() {
        const search = document.getElementById('searchUsers').value.toLowerCase();
        const roleFilter = document.getElementById('filterByRole').value;
        const statusFilter = document.getElementById('filterByStatus').value;

        const rows = document.querySelectorAll('#usersTableBody tr.user-row');
        
        rows.forEach(row => {
            const userData = this.extractRowData(row);
            const matchesSearch = this.matchesSearchQuery(userData, search);
            const matchesRole = !roleFilter || userData.role === roleFilter;
            const matchesStatus = !statusFilter || userData.status === statusFilter;
            
            const shouldShow = matchesSearch && matchesRole && matchesStatus;
            row.style.display = shouldShow ? '' : 'none';
        });

        this.updateResultsCount();
    }

    extractRowData(row) {
        const userText = row.cells[1].textContent.toLowerCase();
        const roleText = row.cells[2].textContent.toLowerCase();
        const statusText = row.cells[4].textContent.toLowerCase();
        
        return {
            text: userText,
            role: row.cells[2].querySelector('.badge').textContent.toLowerCase().replace(' ', '_'),
            status: statusText.includes('active') ? 'active' : 'inactive'
        };
    }

    matchesSearchQuery(userData, search) {
        if (!search) return true;
        return userData.text.includes(search);
    }

    updateResultsCount() {
        const visibleRows = document.querySelectorAll('#usersTableBody tr.user-row[style=""], #usersTableBody tr.user-row:not([style])').length;
        const totalRows = document.querySelectorAll('#usersTableBody tr.user-row').length;
        
        const countElement = document.querySelector('.text-muted');
        if (countElement && countElement.textContent.includes('Showing')) {
            countElement.textContent = `Showing ${visibleRows} of ${totalRows} users`;
        }
    }

    getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    }

    showAlert(message, type = 'info') {
        window.notificationManager?.show(message, type);
    }
}

// Global functions for button actions
function viewUser(userId) {
    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    modal.show();
}

function editUser(userId) {
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

function resetPassword(userId) {
    const form = document.getElementById('resetPasswordForm');
    form.dataset.userId = userId;
    const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
    modal.show();
}

function toggleUserStatus(userId, activate) {
    if (confirm(`Are you sure you want to ${activate ? 'activate' : 'deactivate'} this user?`)) {
        // Handle status toggle
        console.log(`Toggle user ${userId} to ${activate ? 'active' : 'inactive'}`);
    }
}

function exportUsers() {
    window.location.href = '/api/system-admin/export-users/';
}

function refreshUserList() {
    window.location.reload();
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

function generatePassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('password').value = password;
    document.getElementById('password').dispatchEvent(new Event('input'));
}

function generatePasswordReset() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('new_password_reset').value = password;
}

// Initialize UserManager when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    new UserManager();
});
</script>
{% endblock %}